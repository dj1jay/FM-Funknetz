<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Node-Detail – FM-Funknetz</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#0b0c10; color:#e5e7eb; margin:0; }
    header { position:sticky; top:0; z-index:5; display:flex; align-items:center; justify-content:space-between; gap:12px; padding:12px 16px; background:#111827; border-bottom:1px solid #374151; }
    main { padding:16px; display:grid; place-items:center; }
    .card { width:min(1000px,96vw); background:#111827; border:1px solid #374151; border-radius:12px; padding:16px; box-shadow:0 6px 24px rgba(0,0,0,.25); }
    h1 { margin:0; font-size:22px; }
    .muted { color:#9ca3af; font-size:13px; }
    .grid { display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:12px; }
    @media (max-width:900px){ .grid{ grid-template-columns:1fr; } }
    .box { background:#0f172a; border:1px solid #1f2937; border-radius:10px; padding:12px; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    table { width:100%; border-collapse:collapse; }
    td { padding:8px 6px; border-bottom:1px solid #1f2937; vertical-align:top; }
    td:first-child { width:36%; color:#9ca3af; font-weight:600; }
    a { color:#38bdf8; text-decoration:none; }
    a:hover { text-decoration:underline; }
    .chip { display:inline-block; padding:2px 10px; border-radius:999px; border:1px solid #374151; background:#1f2937; font-weight:600; }
    .chip-strong { font-weight:700; }
    .status { font-size:13px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .section-title { margin:6px 0 8px; font-size:15px; font-weight:700; display:flex; justify-content:space-between; align-items:center; }
    .list-inline { display:flex; gap:6px; flex-wrap:wrap; }
    .footer { margin-top:12px; display:flex; justify-content:space-between; align-items:center; }
    #map { width:100%; height:320px; border-radius:10px; border:1px solid #1f2937; }
    .leaflet-container a { color:#60a5fa; }
    .toggle { font-size:12px; border:1px solid #374151; background:#1f2937; color:#e5e7eb; padding:4px 8px; border-radius:6px; cursor:pointer; }
  </style>
</head>
<body>
  <header>
    <div class="row">
      <a href="index.html" aria-label="Zurück" title="Zurück" style="color:#9ca3af">← Zurück</a>
      <span id="nodeTitle" class="mono"></span>
    </div>
    <div class="row status">
    <a href="https://dashboard.fm-funknetz.de" style="color:#38bdf8;text-decoration:none;">Dashboard</a>
    <a href="livemap.html" style="color:#38bdf8;text-decoration:none;">Live-Map</a>
  
    <span id="conn" class="muted">Getrennt</span>
    </div>
  </header>

  <main>
    <div class="card">
      <div class="grid">
        <div class="box">
          <div class="section-title">Allgemein</div>
          <table id="tblA"></table>
        </div>

        <div class="box">
          <div class="section-title">Funk</div>
          <table id="tblB"></table>
        </div>
      </div>

      <div class="box" style="margin-top:12px;">
        <div class="section-title">
          <span>Standort</span>
          <button id="toggleMap" class="toggle" type="button">Karte: Dunkel</button>
        </div>
        <div id="map"></div>
      </div>

      <div class="box" style="margin-top:12px;">
        <div class="section-title">Monitoring / Talkgroups</div>
        <div id="tgWrap" class="list-inline"></div>
      </div>

      <div class="footer muted">
        <span id="updated">Stand: —</span>
        <span id="website"></span>
      </div>
    </div>
  </main>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script>
    const call = new URLSearchParams(location.search).get("call");
    const WS_URL = "wss://status.thueringen.link/mqtt";
    const NODE_TOPIC = "/server/state/nodes/" + (call || "");

    const elConn = document.getElementById("conn");
    const elNodeTitle = document.getElementById("nodeTitle");
    const tblA = document.getElementById("tblA");
    const tblB = document.getElementById("tblB");
    const elTGWrap = document.getElementById("tgWrap");
    const elUpdated = document.getElementById("updated");
    const elWebsite = document.getElementById("website");
    const btnToggle = document.getElementById("toggleMap");

    let map, marker, light, dark, current = "dark";

    function pad(n){ return String(n).padStart(2,"0"); }
    function fmtTime(ms){ const d=new Date(ms); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`; }
    function escapeHtml(s){ return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }
    function typeLabel(d){
      const t = String(d.Type ?? d.raw?.Type ?? "").trim();
      if (t === "1") return "Relais";
      if (t === "2") return "Simplex Link";
      if (t === "3") return "Privater Hotspot";
      return "—";
    }
    function chip(tg, strong){
      const tgStr = String(tg);
      const style = strong ? "border:1px solid #60a5fa; color:#60a5fa; background:rgba(96,165,250,.2);" : "";
      return `<span class="chip mono ${strong ? "chip-strong": ""}" style="${style}">${escapeHtml(tgStr)}</span>`;
    }
    function miniChip(tgStr, highlight){
      if (highlight) return chip(tgStr, true);
      return `<span class="chip mono" style="margin:2px 0;">${escapeHtml(tgStr)}</span>`;
    }

    function renderAll(d){
      elNodeTitle.textContent = call || "Unbekannt";
      elWebsite.innerHTML = d.website ? `<a href="${escapeHtml(d.website)}" target="_blank" rel="noopener">Website</a>` : "";

      const tgActive = Number.parseInt(String(d.tg ?? 0), 10) || 0;
      const defaultTG = String(d.default_tg ?? d.DefaultTG ?? d.raw?.DefaultTG ?? "0");
      const activeChip = (tgActive > 1) ? chip(tgActive, true) : `<span class="chip mono">${tgActive}</span>`;

      const site = (d.website || d.raw?.Website || "").trim();

      const rowsA = [
        ["Rufzeichen", `<span class="mono">${escapeHtml(d.call || call || "")}</span>`],
        ["Type", typeLabel(d)],
        ["Standort", escapeHtml(d.location || d.raw?.nodeLocation || d.raw?.Location || "—")],
        ["Locator", escapeHtml(d.locator || "—")],
        ["Koordinaten", (d.lat!=null && d.lon!=null) ? `${d.lat}, ${d.lon}` : "—"],
        ["Verbund", escapeHtml(d.verbund || "—")],
        ["SysOp", escapeHtml(d.sysop || "—")],
        ["Website", site ? `<a href="${escapeHtml(site)}" target="_blank" rel="noopener">${escapeHtml(site)}</a>` : "—"]
      ];

      const echolinkVal = (d.Echolink ?? d.raw?.Echolink ?? "").toString().trim();
      const echolinkCell = echolinkVal && echolinkVal !== "0" ? `<span class="mono">${escapeHtml(echolinkVal)}</span>` : "—";

      const rowsB = [
        ["Modus", escapeHtml(d.mode || "—")],
        ["RX/TX", `${escapeHtml(d.rx_freq || "—")} / ${escapeHtml(d.tx_freq || "—")}`],
        ["Software", escapeHtml((d.sw || "") + (d.swVer ? " " + d.swVer : "")) || "—"],
        ["Echolink", echolinkCell],
        ["Aktuelle TG", activeChip],
        ["Default TG", `<span class="chip mono">${escapeHtml(defaultTG)}</span>`]
      ];

      tblA.innerHTML = rowsA.map(([k,v]) => `<tr><td>${k}</td><td>${v}</td></tr>`).join("");
      tblB.innerHTML = rowsB.map(([k,v]) => `<tr><td>${k}</td><td>${v}</td></tr>`).join("");

      const list = Array.isArray(d.monitoredTGs) ? d.monitoredTGs : [];
      elTGWrap.innerHTML = list.length
        ? list.map(tg => miniChip(String(tg), tg === tgActive)).join("")
        : `<span class="muted">Keine Daten.</span>`;

      elUpdated.textContent = "Stand: " + fmtTime(Date.now());

      if (d.lat!=null && d.lon!=null){
        if (!map){
          map = L.map('map', {scrollWheelZoom:true}).setView([d.lat, d.lon], 11);
          light = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution:'&copy; OpenStreetMap & CartoDB', maxZoom:19 });
          dark  = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',  { attribution:'&copy; OpenStreetMap & CartoDB', maxZoom:19 });
          dark.addTo(map);
          btnToggle.addEventListener('click', () => {
            if (current === 'dark'){ map.removeLayer(dark); light.addTo(map); current='light'; btnToggle.textContent='Karte: Hell'; }
            else { map.removeLayer(light); dark.addTo(map); current='dark'; btnToggle.textContent='Karte: Dunkel'; }
          });
        } else {
          map.setView([d.lat, d.lon], map.getZoom());
        }
        if (marker) marker.remove();
        marker = L.marker([d.lat, d.lon]).addTo(map);
        marker.bindPopup(`<strong>${escapeHtml(d.call || call || "")}</strong><br/>${escapeHtml(d.location||"")}<br/>TG: ${escapeHtml(String(d.tg ?? 0))}`);
      }
    }

    if (!call) {
      document.querySelector(".card").innerHTML = "<h1>Kein Node angegeben</h1><p class='muted'>Rufe die Seite mit <code>?call=DB0XYZ</code> auf.</p>";
    } else {
      elConn.textContent = "Verbinden…";
      const client = mqtt.connect(WS_URL, { reconnectPeriod:3000, clean:true, clientId:"node-detail-"+Math.random().toString(16).slice(2,10) });
      client.on("connect", () => { elConn.textContent="Verbunden"; client.subscribe(NODE_TOPIC, { qos:0 }); });
      client.on("reconnect", () => { elConn.textContent="Wiederverbinden…"; });
      client.on("close", () => { elConn.textContent="Getrennt"; });
      client.on("error", () => { elConn.textContent="Fehler"; });
      client.on("message", (topic, payload) => { try { const data = JSON.parse(new TextDecoder().decode(payload)); renderAll(data||{}); } catch(e){} });
    }
  </script>
</body>
</html>
