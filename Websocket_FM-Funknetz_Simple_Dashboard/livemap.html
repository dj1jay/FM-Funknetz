<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Live-Map – FM-Funknetz</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <style>
    :root { color-scheme: light dark; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#0b0c10; color:#e5e7eb; }
    header { display:flex; justify-content:space-between; align-items:center; gap:12px; padding:10px 16px; background:#111827; border-bottom:1px solid #374151; }
    h1 { margin:0; font-size:20px; }
    .muted { color:#9ca3af; font-size:12px; }
    #map { width:100%; height: calc(100vh - 64px); }
    .controls {
      position:absolute; top:80px; right:12px; z-index:500;
      background:#0f172a; border:1px solid #1f2937; border-radius:8px; padding:10px 12px; font-size:13px;
      box-shadow: 0 6px 24px rgba(0,0,0,.25); width: 260px;
    }
    .controls label { display:flex; align-items:center; gap:6px; margin:3px 0; white-space:nowrap; }
    .leaflet-container a { color:#60a5fa; }
    .toggle { font-size:12px; border:1px solid #374151; background:#1f2937; color:#e5e7eb; padding:4px 8px; border-radius:6px; cursor:pointer; }
    .lbl { background: rgba(0,0,0,0.6); color:#fff; padding:2px 4px; border-radius:4px; font-size:11px; }
    .popup-row { display:flex; justify-content:space-between; gap:8px; }
    .popup-key { color:#6b7280; min-width:80px; }
    .popup-val { color:#111827; }
    .leaflet-popup-content-wrapper { background:#ffffff; color:#111827; }
    .leaflet-popup-tip { background:#ffffff; }
    .search-wrap { margin-bottom:8px; }
    .search-wrap input[type="text"] {
      width:100%; padding:6px 8px; border-radius:6px; border:1px solid #1f2937;
      background:#0b1220; color:#e5e7eb; outline:none;
    }
    .search-actions { display:flex; gap:6px; align-items:center; margin-top:6px; }
    .btn {
      border:1px solid #374151; background:#1f2937; color:#e5e7eb; padding:4px 8px; border-radius:6px; cursor:pointer; font-size:12px;
    }
    .hint { font-size:11px; color:#9ca3af; margin-top:4px; }
  </style>
</head>
<body>
  <header>
    <h1>Live-Map</h1>
<div><a href="index.html" style="color:#38bdf8;text-decoration:none;">Dashboard</a></div>
    <div class="muted">Filter nach Typ, Klick für Details. <button id="toggleMap" class="toggle" type="button">Karte: Dunkel / Hell</button></div>
 
 </header>
  <div id="map"></div>
  <div class="controls" id="controls">
    <div class="search-wrap">
      <div style="font-weight:600; margin-bottom:4px;">Suche Rufzeichen</div>
      <input id="searchCall" type="text" placeholder="z. B. DB0MGN" list="callsDatalist" autocomplete="off" />
      <datalist id="callsDatalist"></datalist>
      <div class="search-actions">
        <button id="btnGo" class="btn" type="button">Suchen</button>
        <span id="searchHint" class="hint">Tippen zum Vorschlagen</span>
      </div>
    </div>
    <div><strong>Typen</strong></div>
    <label><input type="checkbox" id="t1" checked> Relais (1)</label>
    <label><input type="checkbox" id="t2" checked> Simplex Link (2)</label>
    <label><input type="checkbox" id="t3" checked> Privater Hotspot (3)</label>
    <hr style="border-color:#1f2937">
    <label><input type="checkbox" id="me" checked> Eigene Position zeigen</label>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script>
    const WS_URL = "wss://status.thueringen.link/mqtt";
    const INDEX_TOPIC = "/server/state/nodes_index";
    const NODES_TOPIC = "/server/state/nodes/+";
    const LABEL_ZOOM = 10;

    const map = L.map('map', { scrollWheelZoom: true }).setView([51.15, 10.45], 6);
    const light = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution:'&copy; OpenStreetMap & CartoDB', maxZoom:19 });
    const dark  = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',  { attribution:'&copy; OpenStreetMap & CartoDB', maxZoom:19 });
    let current = "dark"; dark.addTo(map);
    document.getElementById("toggleMap").addEventListener("click", () => {
      if (current === "dark"){ map.removeLayer(dark); light.addTo(map); current="light"; document.getElementById("toggleMap").textContent="Karte: Hell"; }
      else { map.removeLayer(light); dark.addTo(map); current="dark"; document.getElementById("toggleMap").textContent="Karte: Dunkel"; }
    });

    const nodes = new Map();
    const markers = new Map();
    let myMarker = null, myCircle = null, myPos = null;

    function $(id){ return document.getElementById(id); }
    function checked(){ return { t1: $("t1").checked, t2: $("t2").checked, t3: $("t3").checked, me: $("me").checked }; }
    function escapeHtml(s){ return String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }
    function typeLabel(d){
      const t = String(d.Type ?? d.raw?.Type ?? "").trim();
      if (t === "1") return "Relais";
      if (t === "2") return "Simplex Link";
      if (t === "3") return "Privater Hotspot";
      return "—";
    }
    function typeCode(d){ const t = String(d.Type ?? d.raw?.Type ?? "").trim(); return t || "0"; }
    function haversine(lat1, lon1, lat2, lon2){
      const R=6371e3, toRad=x=>x*Math.PI/180;
      const dLat = toRad(lat2-lat1), dLon = toRad(lon2-lon1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(Math.PI*(lon2-lon1)/180/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }
    function fmtDist(m){ return m>=1000 ? (m/1000).toFixed(1)+' km' : Math.round(m)+' m'; }

    function iconUrl(svg){ return "data:image/svg+xml;charset=UTF-8," + encodeURIComponent(svg); }
    const ICONS = {
      "1": L.icon({  // Antennenmast
        iconUrl: iconUrl(`<svg xmlns='http://www.w3.org/2000/svg' width='26' height='26' viewBox='0 0 26 26'>
          <circle cx='13' cy='13' r='12' fill='#1f2937' stroke='#60a5fa' stroke-width='2'/>
          <g transform='translate(13,13)' stroke='#60a5fa' stroke-width='2' fill='none'>
            <line x1='0' y1='-6' x2='0' y2='6'/>
            <line x1='-3' y1='6' x2='3' y2='6'/>
            <path d='M-5 -5 A7 7 0 0 1 5 -5'/>
            <path d='M-7 0 A10 10 0 0 1 7 0'/>
          </g>
        </svg>`),
        iconSize:[26,26], iconAnchor:[13,13], popupAnchor:[0,-12], tooltipAnchor:[0,-12]
      }),
      "2": L.icon({  // Haus mit Antenne
        iconUrl: iconUrl(`<svg xmlns='http://www.w3.org/2000/svg' width='26' height='26' viewBox='0 0 26 26'>
          <circle cx='13' cy='13' r='12' fill='#1f2937' stroke='#f59e0b' stroke-width='2'/>
          <g transform='translate(13,13)' stroke='#f59e0b' stroke-width='2' fill='none'>
            <path d='M-6 2 L0 -3 L6 2 V7 H-6 Z' fill='none'/>
            <line x1='2' y1='-2' x2='2' y2='-7'/>
            <path d='M1 -7 A2 2 0 0 1 3 -7'/>
          </g>
        </svg>`),
        iconSize:[26,26], iconAnchor:[13,13], popupAnchor:[0,-12], tooltipAnchor:[0,-12]
      }),
      "3": L.icon({  // Kästchen mit Antenne
        iconUrl: iconUrl(`<svg xmlns='http://www.w3.org/2000/svg' width='26' height='26' viewBox='0 0 26 26'>
          <circle cx='13' cy='13' r='12' fill='#1f2937' stroke='#34d399' stroke-width='2'/>
          <g transform='translate(13,13)' stroke='#34d399' stroke-width='2' fill='none'>
            <rect x='-4' y='2' width='8' height='5'/>
            <line x1='0' y1='2' x2='0' y2='-5'/>
            <path d='M-2 -5 A3 3 0 0 1 2 -5'/>
          </g>
        </svg>`),
        iconSize:[26,26], iconAnchor:[13,13], popupAnchor:[0,-12], tooltipAnchor:[0,-12]
      }),
      "me": L.icon({  // Person
        iconUrl: iconUrl(`<svg xmlns='http://www.w3.org/2000/svg' width='28' height='28' viewBox='0 0 28 28'>
          <circle cx='14' cy='14' r='12' fill='#1f2937' stroke='#f472b6' stroke-width='2'/>
          <g transform='translate(14,14)' fill='none' stroke='#f472b6' stroke-width='2'>
            <circle cx='0' cy='-3' r='3'/>
            <path d='M-6 7 C-5 2,5 2,6 7'/>
          </g>
        </svg>`),
        iconSize:[28,28], iconAnchor:[14,14], popupAnchor:[0,-14], tooltipAnchor:[0,-14]
      })
    };

    // Suche / Autocomplete
    const input = document.getElementById('searchCall');
    const datalist = document.getElementById('callsDatalist');
    const hint = document.getElementById('searchHint');
    function updateDatalist(prefix){
      const q = String(prefix || "").trim().toUpperCase();
      datalist.innerHTML = "";
      if (!q){ hint.textContent = "Tippen zum Vorschlagen"; return; }
      const opts = [];
      for (const [call] of nodes){
        if (call && call.toUpperCase().startsWith(q)) opts.push(call);
        if (opts.length >= 25) break;
      }
      if (opts.length === 0){
        hint.textContent = "Kein Treffer";
      } else {
        hint.textContent = opts.length + " Vorschläge";
        datalist.innerHTML = opts.map(c => `<option value="${c}"></option>`).join("");
      }
    }
    function focusCall(call){
      if (!call) return;
      const key = [...nodes.keys()].find(k => k.toUpperCase() === call.toUpperCase());
      if (!key){ hint.textContent = "Nicht auf der Karte"; return; }
      const d = nodes.get(key), mk = markers.get(key);
      if (d && mk){
        map.flyTo([d.lat, d.lon], Math.max(map.getZoom(), 11), { duration: 0.6 });
        mk.fire('click');
      } else {
        hint.textContent = "Nicht auf der Karte";
      }
    }
    input.addEventListener('input', (e) => { updateDatalist(e.target.value); });
    input.addEventListener('keydown', (e) => { if (e.key === 'Enter'){ focusCall(input.value.trim()); }});
    document.getElementById('btnGo').addEventListener('click', () => focusCall(input.value.trim()));

    function upsertMarker(call){
      const d = nodes.get(call);
      if (!d || d.lat==null || d.lon==null) return;
      const code = typeCode(d);
      let mk = markers.get(call);
      if (!mk) {
        mk = L.marker([d.lat, d.lon], { icon: ICONS[code] || ICONS["1"] }).addTo(map);
        markers.set(call, mk);
        mk.bindTooltip(`<span class="lbl">${escapeHtml(d.call||call)}</span>`, { direction:"top", offset:[0,-14], opacity:0.9, permanent:false });
        mk.on('click', () => {
          const dist = (myPos && d.lat!=null && d.lon!=null) ? fmtDist(haversine(myPos.lat, myPos.lon, d.lat, d.lon)) : "—";
          const rx = d.rx_freq ? escapeHtml(String(d.rx_freq)) : "—";
          const tx = d.tx_freq ? escapeHtml(String(d.tx_freq)) : "—";
          const sysop = d.sysop ? escapeHtml(String(d.sysop)) : "—";
          const tg = (d.tg != null) ? escapeHtml(String(d.tg)) : "0";
          const html = `
            <div style="min-width:240px">
              <div style="font-weight:700">${escapeHtml(d.call||call)}</div>
              <div class="muted">${escapeHtml(d.location||"")}</div>
              <div class="muted">Typ: ${escapeHtml(typeLabel(d))}</div>
              <div class="popup-row"><span class="popup-key">Frequenz</span><span class="popup-val">${rx} / ${tx}</span></div>
              <div class="popup-row"><span class="popup-key">SysOp</span><span class="popup-val">${sysop}</span></div>
              <div class="popup-row"><span class="popup-key">Aktuelle TG</span><span class="popup-val">${tg}</span></div>
              <div class="popup-row"><span class="popup-key">Entfernung</span><span class="popup-val">${dist}</span></div>
              <div style="margin-top:6px"><a href="node.html?call=${encodeURIComponent(d.call||call)}" target="_blank">Details</a></div>
            </div>`;
          mk.bindPopup(html).openPopup();
        });
      } else {
        mk.setLatLng([d.lat, d.lon]);
        mk.setIcon(ICONS[code] || ICONS["1"]);
        if (mk.getTooltip()) mk.setTooltipContent(`<span class="lbl">${escapeHtml(d.call||call)}</span>`);
      }
    }

    function applyFilters(){
      const f = checked();
      for (const [call, mk] of markers){
        const d = nodes.get(call);
        const code = typeCode(d);
        const show = (code==="1"&&f.t1) || (code==="2"&&f.t2) || (code==="3"&&f.t3) || (code!=="1"&&code!=="2"&&code!=="3");
        if (show) mk.addTo(map); else mk.remove();
      }
      if (f.me) { myMarker && myMarker.addTo(map); myCircle && myCircle.addTo(map); }
      else { myMarker && myMarker.remove(); myCircle && myCircle.remove(); }

      const showLabels = map.getZoom() >= LABEL_ZOOM;
      for (const [, mk] of markers){
        const tt = mk.getTooltip();
        if (!tt) continue;
        if (showLabels) mk.openTooltip();
        else mk.closeTooltip();
      }
    }

    function updateMyPos(pos){
      myPos = { lat: pos.coords.latitude, lon: pos.coords.longitude, acc: pos.coords.accuracy };
      if (!myMarker){
        myMarker = L.marker([myPos.lat, myPos.lon], { icon: ICONS["me"] }).addTo(map);
        myMarker.bindTooltip(`<span class="lbl">Du</span>`, { direction:"top", offset:[0,-14], opacity:0.9 });
        myCircle = L.circle([myPos.lat, myPos.lon], { radius: myPos.acc, color:"#f472b6", fillColor:"#f472b6", fillOpacity:0.15, weight:1 }).addTo(map);
      } else {
        myMarker.setLatLng([myPos.lat, myPos.lon]);
        myCircle.setLatLng([myPos.lat, myPos.lon]).setRadius(myPos.acc);
      }
      applyFilters();
    }
    if (navigator.geolocation){
      navigator.geolocation.getCurrentPosition(updateMyPos, ()=>{}, { enableHighAccuracy:true, timeout:8000, maximumAge:60000 });
      navigator.geolocation.watchPosition(updateMyPos, ()=>{}, { enableHighAccuracy:true, timeout:15000, maximumAge:60000 });
    }

    const client = mqtt.connect(WS_URL, { reconnectPeriod:3000, clean:true, clientId:'livemap-'+Math.random().toString(16).slice(2,10) });
    client.on('connect', () => { client.subscribe([INDEX_TOPIC, NODES_TOPIC], { qos:0 }); });
    client.on('message', (topic, payload) => {
      const text = new TextDecoder().decode(payload);
      try {
        if (topic.startsWith('/server/state/nodes/')){
          const d = JSON.parse(text);
          if (!d || !d.call) return;
          nodes.set(d.call, d);
          upsertMarker(d.call);
          applyFilters();
          if (input.value.trim().length){ updateDatalist(input.value.trim()); }
        }
      } catch(e){}
    });

    map.on('zoomend', applyFilters);
    ['t1','t2','t3','me'].forEach(id => $(id).addEventListener('change', applyFilters));
  </script>
</body>
</html>
